@page "/order/{OrderId:int}"
@using CleanUp.Client.Helpers
@using System.Globalization

@attribute [Authorize]

<PageTitle>Dettaglio ordine</PageTitle>

<div id="order" class="px-5">
    <h1>Dettaglio ordine #@OrderId</h1>
    
    <div class="d-flex justify-content-end">
        <div>
            @if (!loading)
            {
                <table class="totals">
                    <tr>
                        <td class="total">Totale</td>
                        <td>Pezzi: <label>@(order.OrderProducts.Sum(x => x.Quantity))</label></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td>Euro: <label>@(string.Format("{0:0.00}", order.FinalPrice))</label></td>
                    </tr>
                </table>
            }
        </div>
    </div>
    <div class="d-flex justify-content-between">
        <div>
            <div class="p-2"><button class="btn btn-primary" @onclick="@(() => navigationManager.NavigateTo($"/"))">INDIETRO</button></div>
        </div>
        <div>
            @if (!loading && OrderHelper.CanAnyChildOrderBeModified(order))
            {
                <div class="p-2"><button class="btn btn-primary" @onclick="@(() => navigationManager.NavigateTo($"/order/edit/{OrderId}/schedule"))">MODIFICA ORDINE</button></div>
            }
        </div>
    </div>

    <table class="table mt-5">
        <thead>
            <tr>
                <th></th>
                <th>SKU</th>
                <th>Nome prodotto</th>
                <th>Importo</th>
                <th>Prezzo scontato</th>
                @if (!loading && order.ChildrenOrders != null)
                {
                    @foreach (var childOrder in order.ChildrenOrders)
                    {
                        <th>@childOrder.OrderDate.ToString("ddd dd/MM/yyyy", new CultureInfo("it-IT"))</th>
                    }   
                }
                <th>Subtotale</th>
            </tr>
        </thead>
        <tbody>
            @if (loading)
            {
                <tr>
                    <td colspan="6" class="text-center">Caricamento...</td>
                </tr>
            }
            else
            {
                @foreach (var orderProduct in order.OrderProducts.DistinctBy(x => x.ProductId))
                {
                    <tr>
                        <td><a href="" @onclick="() => ProductInfoModal.Open(catalogId, orderProduct.ProductId)" @onclick:preventDefault><img src="/img/info-icon.svg" /></a></td>
                        <td>@orderProduct.Product.Code</td>
                        <td>@orderProduct.Product.Name</td>
                        <td>€ @(Math.Round(orderProduct.Price, 2).ToString("0.00"))</td>
                        <td>€ @(Math.Round(orderProduct.FinalPrice, 2).ToString("0.00"))</td>
                                                
                        @foreach (var childOrder in order.ChildrenOrders)
                        {
                            <td>@(childOrder.OrderProducts.FirstOrDefault(x => x.ProductId == orderProduct.ProductId)?.Quantity ?? 0)</td>
                        }

                        <td>€ @(Math.Round(orderProduct.FinalPrice * order.ChildrenOrders.SelectMany(x => x.OrderProducts).Where(x => x.ProductId == orderProduct.ProductId).Sum(x => x.Quantity) , 2).ToString("0.00"))</td>
                    </tr>
                }
            }
            
        </tbody>
    </table>

</div>

<CleanUp.Client.Shared.Components.ProductInfo @ref="ProductInfoModal" />